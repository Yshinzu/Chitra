<script>
let guardianContacts = JSON.parse(localStorage.getItem("guardianContacts"));
const siren = document.getElementById("sirenSound");

if (!guardianContacts) {
  document.getElementById("contactModal").style.display = "flex";
}

// ‚úÖ Save guardian number (auto +91) and show toast
document.getElementById("saveContacts").onclick = () => {
  let whatsapp = document.getElementById("guardianWhatsapp").value.trim();
  if (!whatsapp) {
    alert("Please enter guardian WhatsApp number.");
    return;
  }

  whatsapp = whatsapp.replace(/\D/g, ""); // remove non-digits
  if (whatsapp.length === 10) whatsapp = "+91" + whatsapp;
  else if (whatsapp.startsWith("91") && whatsapp.length === 12) whatsapp = "+" + whatsapp;
  else if (!whatsapp.startsWith("+91")) whatsapp = "+91" + whatsapp;

  guardianContacts = { guardianWhatsapp: whatsapp };
  localStorage.setItem("guardianContacts", JSON.stringify(guardianContacts));
  document.getElementById("contactModal").style.display = "none";

  // ‚úÖ Toast confirmation (no freeze, no alert)
  const toast = document.createElement("div");
  toast.textContent = "‚úÖ ‡¶Ö‡¶≠‡¶ø‡¶≠‡¶æ‡¶¨‡¶ï‡ßá‡¶∞ ‡¶§‡¶•‡ßç‡¶Ø ‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶ø‡¶§ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá\n‡¶è‡¶ñ‡¶® HELP ME ‡¶ö‡¶æ‡¶™‡ßÅ‡¶® SOS ‡¶™‡¶æ‡¶†‡¶æ‡¶§‡ßá";
  toast.style.cssText = `
    position:fixed;bottom:20px;left:50%;transform:translateX(-50%);
    background:rgba(0,0,0,0.8);color:white;padding:12px 18px;
    border-radius:10px;font-size:15px;z-index:3000;
    text-align:center;white-space:pre-line;`;
  document.body.appendChild(toast);
  setTimeout(() => toast.remove(), 4000);
};

// ‚úÖ Reset saved contact
document.getElementById("resetContacts").onclick = () => {
  localStorage.removeItem("guardianContacts");
  guardianContacts = null;
  document.getElementById("contactModal").style.display = "flex";
};

// ‚úÖ Strict GPS-only live location
async function getLiveGpsLocation(timeoutMs = 15000) {
  return new Promise((resolve) => {
    if (!navigator.geolocation) {
      resolve(null);
      return;
    }

    let best = null;
    const start = Date.now();
    const watchId = navigator.geolocation.watchPosition(
      (pos) => {
        const age = Date.now() - pos.timestamp;
        if (age > 5000) return; // ignore stale data

        const acc = pos.coords.accuracy;
        if (!best || acc < best.accuracy) {
          best = {
            lat: pos.coords.latitude.toFixed(6),
            lng: pos.coords.longitude.toFixed(6),
            accuracy: acc,
            source: "gps",
          };
        }

        if (acc <= 30 || Date.now() - start > timeoutMs) {
          navigator.geolocation.clearWatch(watchId);
          resolve(best);
        }
      },
      (err) => {
        navigator.geolocation.clearWatch(watchId);
        resolve(null);
      },
      { enableHighAccuracy: true, maximumAge: 0, timeout: timeoutMs }
    );

    setTimeout(() => {
      navigator.geolocation.clearWatch(watchId);
      resolve(best);
    }, timeoutMs + 2000);
  });
}

// ‚úÖ IP fallback if GPS fails
async function ipFallback() {
  try {
    const res = await fetch("https://ipapi.co/json/");
    const data = await res.json();
    if (data && data.latitude && data.longitude) {
      return {
        lat: Number(data.latitude).toFixed(6),
        lng: Number(data.longitude).toFixed(6),
        accuracy: 5000,
        source: "ip",
      };
    }
  } catch (e) {}
  return null;
}

// ‚úÖ WhatsApp message sender
function sendWhatsAppMessage(message) {
  const waNumber = guardianContacts.guardianWhatsapp.replace(/\D/g, "");
  const waLink = `https://wa.me/${waNumber}?text=${encodeURIComponent(message)}`;
  setTimeout(() => {
    window.location.href = waLink;
  }, 1200);
}

// ‚úÖ Activate SOS (HELP ME button)
async function activateSiren() {
  if (!guardianContacts) {
    document.getElementById("contactModal").style.display = "flex";
    return;
  }

  const sosBtn = document.getElementById("sosButton");
  sosBtn.classList.add("siren-active");

  try {
    siren.loop = true;
    siren.volume = 1.0;
    await siren.play();
  } catch (e) {}

  document.getElementById("stopSirenBtn").style.display = "inline-block";

  // Toast: locating...
  const toast = document.createElement("div");
  toast.textContent = "üì° Locating your live position...";
  toast.style.cssText = `
    position:fixed;bottom:20px;left:50%;transform:translateX(-50%);
    background:rgba(0,0,0,0.7);color:white;padding:10px 16px;
    border-radius:8px;font-size:14px;z-index:2000;`;
  document.body.appendChild(toast);

  const loc = await getLiveGpsLocation();
  toast.remove();

  let finalLoc = loc || (await ipFallback());
  if (!finalLoc) {
    sendWhatsAppMessage("üö® ‡¶Ü‡¶Æ‡¶ø ‡¶¨‡¶ø‡¶™‡¶¶‡ßá ‡¶Ü‡¶õ‡¶ø! ‡¶≤‡ßã‡¶ï‡ßá‡¶∂‡¶® ‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø‡•§ ‡¶¶‡¶Ø‡¶º‡¶æ ‡¶ï‡¶∞‡ßá ‡¶¶‡ßç‡¶∞‡ßÅ‡¶§ ‡¶Ø‡ßã‡¶ó‡¶æ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®‡•§ - ‡¶ö‡¶ø‡¶§‡ßç‡¶∞‡¶æ SOS");
    setTimeout(stopSiren, 60000);
    return;
  }

  const mapLink = `https://www.google.com/maps?q=${finalLoc.lat},${finalLoc.lng}`;
  const msg = `üö® ‡¶Ü‡¶Æ‡¶ø ‡¶¨‡¶ø‡¶™‡¶¶‡ßá ‡¶Ü‡¶õ‡¶ø! ‡¶¶‡¶Ø‡¶º‡¶æ ‡¶ï‡¶∞‡ßá ‡¶¶‡ßç‡¶∞‡ßÅ‡¶§ ‡¶Ø‡ßã‡¶ó‡¶æ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®!\nüìç ‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶Ö‡¶¨‡¶∏‡ßç‡¶•‡¶æ‡¶®: ${mapLink}\nüéØ ‡¶â‡ßé‡¶∏:

