<!DOCTYPE html>
<html lang="bn">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>‡¶ö‡¶ø‡¶§‡ßç‡¶∞‡¶æ SOS</title>

  <style>
    body {
      font-family: 'Poppins', sans-serif;
      background: url("https://images.unsplash.com/photo-1600195077077-8e48f8f112f5?fit=crop&w=1600&h=900") center/cover fixed;
      color: white;
      margin: 0;
    }
    .overlay { background: rgba(0, 0, 0, 0.4); min-height: 100vh; }
    .sos-button {
      width: 200px; height: 200px;
      border-radius: 50%;
      background: radial-gradient(circle, #ff4d4d, #ff0000);
      box-shadow: 0 0 40px rgba(255, 77, 77, .6);
      cursor: pointer;
      animation: pulse 2s infinite;
      display: flex; flex-direction: column;
      align-items: center; justify-content: center;
    }
    @keyframes pulse {
      0% { box-shadow: 0 0 0 0 rgba(255, 77, 77, 0.7); }
      70% { box-shadow: 0 0 0 20px rgba(255, 77, 77, 0); }
      100% { box-shadow: 0 0 0 0 rgba(255, 77, 77, 0); }
    }
    @keyframes siren {
      0% { background: radial-gradient(circle, #ff0000, #990000); }
      50% { background: radial-gradient(circle, #0000ff, #000099); }
      100% { background: radial-gradient(circle, #ff0000, #990000); }
    }
    .siren-active { animation: siren .5s infinite alternate, pulse 2s infinite; }
    .modal {
      display: flex; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.7); justify-content: center; align-items: center;
      z-index: 1000;
    }
    .modal-content {
      background: white; color: black; padding: 20px; border-radius: 12px;
      max-width: 400px; width: 90%; display: flex; flex-direction: column;
    }
    .modal-content input {
      width: 100%; margin-bottom: 10px; padding: 8px;
      border: 1px solid #ccc; border-radius: 6px;
    }
    button { cursor: pointer; }
    #accuracyInfo { margin-top:12px; font-size:14px; color:#f87171; }
  </style>
</head>
<body>
<audio id="sirenSound" src="https://actions.google.com/sounds/v1/alarms/police_siren.ogg" preload="auto"></audio>

<div class="overlay">
  <header style="background:rgba(0,0,0,0.7); padding:16px; text-align:center;">
    <h1 style="font-size:48px; color:#f87171;">‡¶ö‡¶ø‡¶§‡ßç‡¶∞‡¶æ</h1>
  </header>
  <main style="display:flex; flex-direction:column; align-items:center; justify-content:center; text-align:center; padding:32px;">
    <h2 style="font-size:32px; margin-bottom:16px;">üö® ‡¶ú‡¶∞‡ßÅ‡¶∞‡ßÄ ‡¶∏‡¶π‡¶æ‡¶Ø‡¶º‡¶§‡¶æ</h2>
    <p style="color:#e5e7eb; margin-bottom:32px; max-width:400px;">
      SOS ‡¶¨‡¶æ‡¶ü‡¶®‡ßá ‡¶ö‡¶æ‡¶™‡ßÅ‡¶®, ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶≤‡ßã‡¶ï‡ßá‡¶∂‡¶® ‡¶∏‡¶π ‡¶¨‡¶æ‡¶∞‡ßç‡¶§‡¶æ ‡¶ó‡¶æ‡¶∞‡ßç‡¶°‡¶ø‡¶Ø‡¶º‡¶æ‡¶® ‡¶ì ‡¶™‡ßÅ‡¶≤‡¶ø‡¶∂‡ßá‡¶∞ ‡¶ï‡¶æ‡¶õ‡ßá ‡¶™‡¶æ‡¶†‡¶æ‡¶®‡ßã ‡¶π‡¶¨‡ßá‡•§
    </p>
    <div class="sos-button" id="sosButton">
      <span style="font-size:48px;">üö®</span>
      <span style="color:white; font-weight:bold; margin-top:8px;">HELP ME</span>
    </div>
    <p id="accuracyInfo"></p>
    <button id="stopSirenBtn" style="display:none; background:#dc2626; color:white; padding:12px 24px; border-radius:8px; font-weight:bold; margin-top:16px;">Stop Alarm</button>
    <button id="resetContacts" style="background:#6b7280; color:white; padding:8px 16px; border-radius:6px; font-size:14px; margin-top:12px;">Reset Guardian</button>
  </main>
</div>

<div class="modal" id="contactModal">
  <div class="modal-content">
    <h2 style="font-size:20px; margin-bottom:8px;">‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶Ö‡¶≠‡¶ø‡¶≠‡¶æ‡¶¨‡¶ï‡ßá‡¶∞ ‡¶§‡¶•‡ßç‡¶Ø ‡¶¶‡¶ø‡¶®</h2>
    <input type="text" id="guardianWhatsapp" placeholder="Guardian WhatsApp (+91...)" />
    <button id="saveContacts" style="background:#dc2626; color:white; padding:12px; border-radius:8px; font-weight:bold;">Save</button>
  </div>
</div>

<script>
  let guardianContacts = JSON.parse(localStorage.getItem("guardianContacts"));

  if (!guardianContacts) {
    document.getElementById("contactModal").style.display = "flex";
  }

  document.getElementById("saveContacts").onclick = () => {
    const whatsapp = document.getElementById("guardianWhatsapp").value.trim();
    if (!whatsapp) { alert("Please enter guardian WhatsApp number."); return; }
    guardianContacts = { guardianWhatsapp: whatsapp };
    localStorage.setItem("guardianContacts", JSON.stringify(guardianContacts));
    document.getElementById("contactModal").style.display = "none";
    alert("Contacts ‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶£ ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá ‚úÖ");
  };

  document.getElementById("resetContacts").onclick = () => {
    localStorage.removeItem("guardianContacts");
    guardianContacts = null;
    document.getElementById("contactModal").style.display = "flex";
  };

  // Highest accuracy location
  async function getHighAccuracyLocation(threshold = 5, maxWait = 60000) {
    return new Promise((resolve, reject) => {
      if (!navigator.geolocation) return reject("Geolocation not supported");

      const startTime = Date.now();
      const accuracyDisplay = document.getElementById("accuracyInfo");

      const checkPosition = () => {
        navigator.geolocation.getCurrentPosition(
          pos => {
            const lat = pos.coords.latitude.toFixed(6);
            const lng = pos.coords.longitude.toFixed(6);
            const accuracy = pos.coords.accuracy;

            accuracyDisplay.textContent = `Current GPS Accuracy: ${accuracy} meters`;

            if (accuracy <= threshold || Date.now() - startTime > maxWait) {
              resolve({ lat, lng, accuracy });
            } else {
              setTimeout(checkPosition, 1000);
            }
          },
          err => reject("Unable to get location: " + err.message),
          { enableHighAccuracy: true, timeout: 30000, maximumAge: 0 }
        );
      };

      checkPosition();
    });
  }

  async function activateSiren() {
    if (!guardianContacts) {
      alert("Please enter guardian contact first!");
      document.getElementById("contactModal").style.display = "flex";
      return;
    }

    const sosBtn = document.getElementById("sosButton");
    sosBtn.classList.add("siren-active");
    const siren = document.getElementById("sirenSound");
    siren.loop = true; siren.play();
    document.getElementById("stopSirenBtn").style.display = "inline-block";

    try {
      const loc = await getHighAccuracyLocation();
      if (!loc) { alert("Location unavailable."); stopSiren(); return; }

      const coords = `${loc.lat},${loc.lng}`;
      const mapLink = `https://www.google.com/maps/search/?api=1&query=${coords}`;
      const msg = `üö® HELP ME! I'M IN DANGER!\nüìç My Location: ${mapLink}\nüõ∞ Accuracy: ${loc.accuracy} meters`;
      
      // WhatsApp message
      const waLink = `https://wa.me/${guardianContacts.guardianWhatsapp}?text=${encodeURIComponent(msg)}`;
      window.open(waLink, "_blank");

    } catch (err) {
      alert(err);
      stopSiren();
    }

    setTimeout(stopSiren, 60000);
  }

  function stopSiren() {
    document.getElementById("sosButton").classList.remove("siren-active");
    const siren = document.getElementById("sirenSound");
    siren.pause(); siren.currentTime = 0;
    document.getElementById("stopSirenBtn").style.display = "none";
    document.getElementById("accuracyInfo").textContent = "";
  }

  document.getElementById("sosButton").onclick = activateSiren;
  document.getElementById("stopSirenBtn").onclick = stopSiren;
</script>
</body>
</html>
