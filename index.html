<!DOCTYPE html>
<html lang="bn">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>‡¶ö‡¶ø‡¶§‡ßç‡¶∞‡¶æ SOS</title>

  <style>
    body {
      font-family: 'Poppins', sans-serif;
      background: url("https://images.unsplash.com/photo-1600195077077-8e48f8f112f5?fit=crop&w=1600&h=900") center/cover fixed;
      color: white;
      margin: 0;
    }
    .overlay { background: rgba(0, 0, 0, 0.4); min-height: 100vh; }
    .sos-button {
      width: 200px; height: 200px;
      border-radius: 50%;
      background: radial-gradient(circle, #ff4d4d, #ff0000);
      box-shadow: 0 0 40px rgba(255, 77, 77, .6);
      cursor: pointer;
      animation: pulse 2s infinite;
      display: flex; flex-direction: column;
      align-items: center; justify-content: center;
    }
    @keyframes pulse {
      0% { box-shadow: 0 0 0 0 rgba(255, 77, 77, 0.7); }
      70% { box-shadow: 0 0 0 20px rgba(255, 77, 77, 0); }
      100% { box-shadow: 0 0 0 0 rgba(255, 77, 77, 0); }
    }
    @keyframes siren {
      0% { background: radial-gradient(circle, #ff0000, #990000); }
      50% { background: radial-gradient(circle, #0000ff, #000099); }
      100% { background: radial-gradient(circle, #ff0000, #990000); }
    }
    .siren-active { animation: siren .5s infinite alternate, pulse 2s infinite; }
    .modal {
      display: flex; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.7); justify-content: center; align-items: center;
      z-index: 1000;
    }
    .modal-content {
      background: white; color: black; padding: 20px; border-radius: 12px;
      max-width: 400px; width: 90%; display: flex; flex-direction: column;
    }
    .modal-content input {
      width: 100%; margin-bottom: 10px; padding: 8px;
      border: 1px solid #ccc; border-radius: 6px;
    }
    button { cursor: pointer; }
  </style>
</head>
<body>
<audio id="sirenSound" src="https://actions.google.com/sounds/v1/alarms/police_siren.ogg" preload="auto"></audio>

<div class="overlay">
  <header style="background:rgba(0,0,0,0.7); padding:16px; text-align:center;">
    <h1 style="font-size:48px; color:#f87171;">‡¶ö‡¶ø‡¶§‡ßç‡¶∞‡¶æ</h1>
  </header>
  <main style="display:flex; flex-direction:column; align-items:center; justify-content:center; text-align:center; padding:32px;">
    <h2 style="font-size:32px; margin-bottom:16px;">üö® ‡¶ú‡¶∞‡ßÅ‡¶∞‡ßÄ ‡¶∏‡¶π‡¶æ‡¶Ø‡¶º‡¶§‡¶æ</h2>
    <p style="color:#e5e7eb; margin-bottom:32px; max-width:400px;">
      SOS ‡¶¨‡¶æ‡¶ü‡¶®‡ßá ‡¶ö‡¶æ‡¶™‡ßÅ‡¶®, ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶≤‡ßã‡¶ï‡ßá‡¶∂‡¶® ‡¶∏‡¶π ‡¶¨‡¶æ‡¶∞‡ßç‡¶§‡¶æ ‡¶ó‡¶æ‡¶∞‡ßç‡¶°‡¶ø‡¶Ø‡¶º‡¶æ‡¶®‡ßá‡¶∞ ‡¶ï‡¶æ‡¶õ‡ßá ‡¶™‡¶æ‡¶†‡¶æ‡¶®‡ßã ‡¶π‡¶¨‡ßá‡•§
    </p>
    <div class="sos-button" id="sosButton">
      <span style="font-size:48px;">üö®</span>
      <span style="color:white; font-weight:bold; margin-top:8px;">HELP ME</span>
    </div>
    <button id="stopSirenBtn" style="display:none; background:#dc2626; color:white; padding:12px 24px; border-radius:8px; font-weight:bold; margin-top:16px;">Stop Alarm</button>
    <button id="resetContacts" style="background:#6b7280; color:white; padding:8px 16px; border-radius:6px; font-size:14px; margin-top:12px;">Reset Guardian</button>
  </main>
</div>

<div class="modal" id="contactModal">
  <div class="modal-content">
    <h2 style="font-size:20px; margin-bottom:8px;">‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶Ö‡¶≠‡¶ø‡¶≠‡¶æ‡¶¨‡¶ï‡ßá‡¶∞ WhatsApp ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ ‡¶¶‡¶ø‡¶®</h2>
    <input type="text" id="guardianWhatsapp" placeholder="Guardian WhatsApp (+91...)" />
    <button id="saveContacts" style="background:#dc2626; color:white; padding:12px; border-radius:8px; font-weight:bold;">Save</button>
  </div>
</div>
<script>
/*
  Improved location logic:
  - Uses watchPosition to collect multiple samples
  - Chooses the sample with the smallest accuracy value
  - Waits up to MAX_WAIT_MS for a good reading (DESIRED_ACCURACY_M)
  - Falls back to IP-based lookup only if no GPS readings come in
  - Auto-adds +91 prefix when saving guardian number
*/

const MAX_WAIT_MS = 12000;           // how long to wait for good GPS fixes
const DESIRED_ACCURACY_M = 50;       // target accuracy (meters) to accept early
let guardianContacts = JSON.parse(localStorage.getItem("guardianContacts"));
const siren = document.getElementById("sirenSound");

if (!guardianContacts) {
  document.getElementById("contactModal").style.display = "flex";
}

// Save guardian number (auto +91)
document.getElementById("saveContacts").onclick = () => {
  let whatsapp = document.getElementById("guardianWhatsapp").value.trim();
  if (!whatsapp) {
    alert("Please enter guardian WhatsApp number.");
    return;
  }
  // Clean number and ensure +91 prefix
  whatsapp = whatsapp.replace(/\D/g, ""); // remove non-digit chars
  if (whatsapp.length === 10) whatsapp = "+91" + whatsapp;
  else if (whatsapp.length === 12 && whatsapp.startsWith("91")) whatsapp = "+" + whatsapp;
  else if (whatsapp.startsWith("+91") && whatsapp.length === 13) { /* ok */ }
  else {
    // If it's some other length, still prefix +91 but warn
    whatsapp = "+91" + whatsapp;
  }

  guardianContacts = { guardianWhatsapp: whatsapp };
  localStorage.setItem("guardianContacts", JSON.stringify(guardianContacts));
  document.getElementById("contactModal").style.display = "none";
  alert("‡¶§‡¶•‡ßç‡¶Ø ‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶£ ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá ‚úÖ ‡¶è‡¶ñ‡¶® HELP ME ‡¶¨‡¶æ‡¶ü‡¶®‡ßá ‡¶ö‡¶æ‡¶™‡ßÅ‡¶® SOS ‡¶™‡¶æ‡¶†‡¶æ‡¶§‡ßá‡•§");
};

document.getElementById("resetContacts").onclick = () => {
  localStorage.removeItem("guardianContacts");
  guardianContacts = null;
  document.getElementById("contactModal").style.display = "flex";
};

// Primary: get best GPS fix by sampling multiple readings
function getBestGpsFix(timeoutMs = MAX_WAIT_MS, desiredAccuracy = DESIRED_ACCURACY_M) {
  return new Promise((resolve) => {
    if (!navigator.geolocation) {
      resolve(null);
      return;
    }

    let best = null;
    let watchId = null;
    const start = Date.now();

    function finishAndCleanup(result) {
      if (watchId !== null) navigator.geolocation.clearWatch(watchId);
      resolve(result);
    }

    // Success callback collects readings and chooses the best
    function onSuccess(pos) {
      const reading = {
        lat: pos.coords.latitude,
        lng: pos.coords.longitude,
        accuracy: pos.coords.accuracy,
        timestamp: pos.timestamp,
      };

      // Keep the best (smallest accuracy)
      if (!best || reading.accuracy < best.accuracy) best = reading;

      // If it's already good enough, finish early
      if (reading.accuracy <= desiredAccuracy) {
        finishAndCleanup({
          lat: reading.lat.toFixed(6),
          lng: reading.lng.toFixed(6),
          accuracy: Math.round(reading.accuracy),
          source: "gps",
        });
      } else {
        // If we've already waited long enough, finish with best
        if (Date.now() - start >= timeoutMs) {
          if (best) {
            finishAndCleanup({
              lat: best.lat.toFixed(6),
              lng: best.lng.toFixed(6),
              accuracy: Math.round(best.accuracy),
              source: "gps",
            });
          } else {
            finishAndCleanup(null);
          }
        }
        // else keep watching until timeout or desiredAccuracy reached
      }
    }

    function onError(err) {
      // If permission denied or other fatal error, stop and return null
      // If PERMISSION_DENIED, no point retrying
      if (err && err.code === 1) { // PERMISSION_DENIED
        finishAndCleanup(null);
        return;
      }
      // Otherwise, wait until timeout; gps may still recover; do nothing here
    }

    // Start watching position with high accuracy and small frequency
    try {
      watchId = navigator.geolocation.watchPosition(onSuccess, onError, {
        enableHighAccuracy: true,
        maximumAge: 0,
        timeout: timeoutMs
      });

      // Safety timeout in case watchPosition doesn't call back quickly
      setTimeout(() => {
        if (best) {
          finishAndCleanup({
            lat: best.lat.toFixed(6),
            lng: best.lng.toFixed(6),
            accuracy: Math.round(best.accuracy),
            source: "gps",
          });
        } else {
          finishAndCleanup(null);
        }
      }, timeoutMs + 500); // small buffer
    } catch (e) {
      finishAndCleanup(null);
    }
  });
}

// IP fallback if GPS fails
async function ipFallback() {
  try {
    const res = await fetch("https://ipapi.co/json/");
    const data = await res.json();
    if (data && data.latitude && data.longitude) {
      return {
        lat: Number(data.latitude).toFixed(6),
        lng: Number(data.longitude).toFixed(6),
        accuracy: 5000,
        source: "ip",
      };
    }
  } catch (e) {
    // ignore
  }
  return null;
}

// Compose and send WhatsApp message (opens wa.me)
function sendWhatsAppMessage(message) {
  const waNumber = guardianContacts.guardianWhatsapp.replace(/\D/g, "");
  const waLink = `https://wa.me/${waNumber}?text=${encodeURIComponent(message)}`;
  // Delay a beat to let UI update / siren start
  setTimeout(() => { window.location.href = waLink; }, 1200);
}

// Main SOS flow triggered by HELP ME button
async function activateSiren() {
  if (!guardianContacts) {
    alert("Please enter guardian contact first!");
    document.getElementById("contactModal").style.display = "flex";
    return;
  }

  const sosBtn = document.getElementById("sosButton");
  sosBtn.classList.add("siren-active");
  try {
    siren.loop = true;
    siren.volume = 1.0;
    // Web Audio boost attempt (graceful fallback)
    try {
      const audioContext = new (window.AudioContext || window.webkitAudioContext)();
      const track = audioContext.createMediaElementSource(siren);
      const gainNode = audioContext.createGain();
      gainNode.gain.value = 1.6; // moderate boost; increase carefully if desired
      track.connect(gainNode).connect(audioContext.destination);
      audioContext.resume();
    } catch (e) {
      // not supported ‚Äî continue with element volume
    }
    await siren.play();
  } catch (e) {
    // autoplay or play() rejection ‚Äî user gesture (we have one), ignore
  }
  document.getElementById("stopSirenBtn").style.display = "inline-block";

  // Inform user
  // Prefer a gentle non-blocking overlay; fallback to alert if overlay not present
  try {
    // Create a small temporary toast/overlay element
    let toast = document.createElement("div");
    toast.id = "chitra-loc-toast";
    toast.style.position = "fixed";
    toast.style.bottom = "18px";
    toast.style.left = "50%";
    toast.style.transform = "translateX(-50%)";
    toast.style.background = "rgba(0,0,0,0.7)";
    toast.style.color = "white";
    toast.style.padding = "10px 14px";
    toast.style.borderRadius = "8px";
    toast.style.zIndex = 2000;
    toast.style.fontSize = "14px";
    toast.textContent = "üì° Locating (will use best GPS fix available)...";
    document.body.appendChild(toast);
  } catch (e) {
    alert("üì° Locating your current position... please wait.");
  }

  // Try to get best GPS fix
  const loc = await getBestGpsFix(MAX_WAIT_MS, DESIRED_ACCURACY_M);

  // remove toast if present
  const t = document.getElementById("chitra-loc-toast");
  if (t) t.remove();

  let finalLoc = loc;
  if (!finalLoc) {
    // attempt IP fallback
    finalLoc = await ipFallback();
  }

  if (!finalLoc) {
    // No location at all
    sendWhatsAppMessage("üö® ‡¶Ü‡¶Æ‡¶ø ‡¶¨‡¶ø‡¶™‡¶¶‡ßá ‡¶Ü‡¶õ‡¶ø! ‡¶≤‡ßã‡¶ï‡ßá‡¶∂‡¶® ‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø‡•§ ‡¶¶‡¶Ø‡¶º‡¶æ ‡¶ï‡¶∞‡ßá ‡¶¶‡ßç‡¶∞‡ßÅ‡¶§ ‡¶Ø‡ßã‡¶ó‡¶æ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®‡•§ - ‡¶ö‡¶ø‡¶§‡ßç‡¶∞‡¶æ SOS");
    // auto stop later
    setTimeout(stopSiren, 60000);
    return;
  }

  // Compose message including accuracy and source to help responders
  const mapLink = `https://www.google.com/maps?q=${finalLoc.lat},${finalLoc.lng}`;
  const accuracyText = finalLoc.accuracy ? ` (¬±${finalLoc.accuracy}m)` : "";
  const msg = `üö® ‡¶Ü‡¶Æ‡¶ø ‡¶¨‡¶ø‡¶™‡¶¶‡ßá ‡¶Ü‡¶õ‡¶ø! ‡¶¶‡¶Ø‡¶º‡¶æ ‡¶ï‡¶∞‡ßá ‡¶¶‡ßç‡¶∞‡ßÅ‡¶§ ‡¶Ø‡ßã‡¶ó‡¶æ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®!\nüìç ‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶Ö‡¶¨‡¶∏‡ßç‡¶•‡¶æ‡¶®: ${mapLink}${accuracyText}\nüéØ ‡¶â‡ßé‡¶∏: ${finalLoc.source.toUpperCase()}\n\n- ‡¶ö‡¶ø‡¶§‡ßç‡¶∞‡¶æ SOS`;

  sendWhatsAppMessage(msg);

  // stop siren after reasonable time (clean up)
  setTimeout(stopSiren, 60000);
}

function stopSiren() {
  const sosBtn = document.getElementById("sosButton");
  sosBtn.classList.remove("siren-active");
  try { siren.pause(); siren.currentTime = 0; } catch (e) {}
  document.getElementById("stopSirenBtn").style.display = "none";
}

// Bindings
document.getElementById("sosButton").onclick = activateSiren;
document.getElementById("stopSirenBtn").onclick = stopSiren;
</script>
</body>
</html>



